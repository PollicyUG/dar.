{% extends "bootstrap/base.html" %}
{% import "bootstrap/fixes.html" as fixes %}

{% block title %}Question{% endblock %}

{% block content %}

<!-- Load HighCharts.js -->
<script src="https://code.highcharts.com/highcharts.js"></script>

<!-- Load bot ui scripts-->
<script src="https://cdn.jsdelivr.net/vue/latest/vue.min.js"></script>
<script src="https://unpkg.com/botui/build/botui.min.js"></script>

<!-- Load jQuery -->
<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>

<!-- Custom styles for this template -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/jumbotron.css') }}">

<!-- Custom styles for the bot UI -->
<link rel="stylesheet" href="https://unpkg.com/botui/build/botui.min.css" />
<link rel="stylesheet" href="https://unpkg.com/botui/build/botui-theme-default.css" />

<!-- to go back to default bootstrap background color, simply delete
     style="background-color:#4682B4" -->
<div class="jumbotron" style="background-color:#4682B4">
  <div class="container">

      <h1 id="title"><center>Policy DataBot</center></h1>

      <div class="row">
        <div class="wrapper">                    
          <article class="text">
          	<center>
            <p class="intro">Explore data from policy research papers. Interact with the bot and get to know how many research studies have found evidence for or against a given policy consequence. Note that these are only open access papers and do not represent the opinion of all peer reviewed research.</p>
            <br>
            <p class="intro">At the moment, the databot only supports specific types of questions. The question generated by the bot depends on user input but it is always of the kind that asks about the effect of a given policy on a particular phenomenon e.g. Does cap and trade reduce carbon emissions?</p>
            </center>
          </article>
          
          <div id="my-botui-app">
            <bot-ui></bot-ui>
          </div>
        </div>

        <script>
          var replies = {}
          var botui = new BotUI('my-botui-app');

          botui.message.add({ // show a message
            cssClass: 'custom-class',
            content: "Hi, there! Welcome. My name is DAR and I am here to help you answer policy related questions. I'm feeling pretty good today. How are you?"
          }).then(function () {
            return botui.action.button({
              action : [
                // show three buttons
                { 
                  text: 'Good',
                  value: 'good'
                },
                {
                  text: "Really Good",
                  value: 'really_good'
                },
                {
                  text: "Really, really Good",
                  value: 'awfully_good'
                }
              ]
            });
          }).then(function (res) { // wait till its shown
            return botui.message.add({ 
              content: "Happy to hear that. What's your name?"
            });
          }).then(function () { 
            return botui.action.text({ 
              action: {
                placeholder: 'Your name'
              }
            });
          }).then(function (res) { // get the result
            replies['name'] = res.value
            return botui.message.add({
              content: 'Nice to meet you, ' + res.value + '.'
            });
          }).then(function() {
            return botui.message.add({
              content: 'What policy would you like to research today?'
            });
          }).then(function () {
            return botui.action.text({ 
              action: {
                placeholder: 'Enter policy'
              }
            });
          }).then(function (res) { 
            replies['policy'] = res.value
            return botui.message.add({
              content: 'And what entity would you like to know the effect of ' + res.value + ' on ?'
            });
          }).then(function () {
            return botui.action.text({ 
              action: {
                placeholder: 'Enter phenomenon'
              }
            });
          }).then(function (res) {
            replies['phenomenon'] = res.value
            var policy = replies['policy'] 
            return botui.message.add({
              content: 'So you would like to know the effect that ' + policy + ' has on ' + res.value +'?' 
            });
          }).then(function () {
            return botui.action.button({
              action : [
                { 
                  text: 'Yes',
                  value: 'yes'
                },
                {
                  text: "No",
                  value: 'no'
                }
              ]
            });
          }).then(function () {
            var policy = replies['policy'] 
            var phenomenon = replies['phenomenon']  
            return botui.message.add({
              content: 'And what effect of ' + policy + ' ' + 'on ' + phenomenon + ' ' + 'are you interested in?'
            });
          }).then(function() {
            return botui.action.button({
              action : [
                { 
                  text: 'Increase',
                  value: 'increase'
                },
                {
                  text: "Decrease",
                  value: 'decrease'
                }
              ]
            });
          }).then(function(res) {
            replies['direction'] = res.value
            return botui.message.add({
             content: 'Okay. Please wait while I carry out a survey of research articles about your policy and phenomenon of interest. This could take a few minutes.'
            });
          }).then(function () {
              replies['question'] = 'Does ' + replies['policy'] + ' ' + replies['direction'] + ' ' + replies['phenomenon'] + '?'
              console.log(replies) 
              return botui.message.add({
                loading:true
              });
          }).then(function (index) {
            // start the asynchronous task
            var url = "{{ url_for('backgroundtask') }}";
            var data = replies
            
            $.ajax({
              type: "POST",
              url: url,
              contentType: "application/json; charset=utf-8",
              data: JSON.stringify(data),
              success: function(data, status, request) {
                // the data here is the response from the server not the data that we sent
                console.log(data)
                status_url = request.getResponseHeader('Location');
                // check progress of task
                update_progress(status_url) 
              }
            });
            
            /**
            botui.message.update(index, {
              loading: false,
              content: 'Shown below are the results for your question.'
            });
            **/
          });

          function update_progress(status_url) {
            // send GET request to a status URL
            $.getJSON(status_url, function(data) {
              console.log(data);
              
              // the data here is the response from the server not the data that we sent
              if (data['task_status'] != 'PENDING' && data['task_status'] != 'PROGRESS') {
                if ('results' in data) {
                  // send results to client
                  var results = data['results']
                  console.log(results);
                  var result_url = '/result'
                  var data = {'results': results, 'replies': replies}
                  send_result(result_url, data);
                }
              }
              else {
                console.log(data);
                // rerun in 20 seconds
                setTimeout(function() {
                  update_progress(status_url);
                }, 20000);
              }
            }); 
          }

          function send_result(result_url, results) {
            // send POST request to a result URL
            $.ajax({
                type: "POST",
                url: result_url,
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(results),
                success: function(data, status, request) {
                  // the data here is the response from the server not the data that we sent
                  // use $("body").html(data) if you want to display the results on a new page
                  $("#footer").remove();
                  $("body").append(data);               
                }
              });
          }
        </script>
  
      </div>
      
  </div>
</div>

<!-- Footer for the entire page -->
<div id="footer" class="text">
  <center>
  <p>
    (c) 2019 Pollicy.
  </p>
  </center>      
</div>

{% endblock %}

{% block head %}
{{super()}}
{{fixes.ie8()}}
{% endblock %}